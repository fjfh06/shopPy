{% extends "base.html" %}

{% block title %}Carrito de Compras{% endblock %}

{% block content %}
<div class="cart-container">

{% if carrito %}

{% set ns = namespace(subtotal=0) %}

<div class="cart-content">
    <table class="cart-table">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th>Acciones</th>
            </tr>
        </thead>
        {% set ns = namespace(subtotal=0) %}

{% set ns = namespace(subtotal=0) %}

<tbody>
{% for item in carrito %}
    {% set item_subtotal = item.price|float * item.cantidad %}
    {% set item_subtotal_iva = item_subtotal * 1.21 %}
    {% set ns.subtotal = ns.subtotal + item_subtotal %}

    <tr class="cart-item">
        <td>{{ item.name }}</td>

        <td>{{ "%.2f"|format(item.price|float) }}€</td>

        <td class="quantity">
            <form action="/eliminar_del_carrito/{{ item.id }}" method="POST">
                <button type="submit" name="accion" value="decrementar" class="btn-qty">-</button>
            </form>
            <span>{{ item.cantidad }}</span>
            <form action="/carrito/{{ item.id }}" method="POST">
                <button type="submit" name="accion" value="incrementar" class="btn-qty">+</button>
            </form>
        </td>

        <td>{{ "%.2f"|format(item_subtotal_iva) }}€</td>

        <td>
            <form action="/eliminar_del_carrito/{{ item.id }}" method="POST">
                <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
        </td>
    </tr>
{% endfor %}
</tbody>

    </table>
</div>

<div class="cart-summary">
    <div class="summary-row">
        <span>Subtotal (sin IVA):</span>
        <span>{{ "%.2f"|format(ns.subtotal) }}€</span>
    </div>
    <div class="summary-row">
        <span>IVA (21%):</span>
        <span>{{ "%.2f"|format(ns.subtotal * 0.21) }}€</span>
    </div>
    <div class="summary-row total">
        <span>Total:</span>
        <span>{{ "%.2f"|format(ns.subtotal * 1.21) }}€</span>
    </div>

    <div class="cart-actions">
        <form action="/" method="GET">
            <button class="btn btn-primary">Seguir Comprando</button>
        </form>
        <form action="{{ url_for('realizar_pedido') }}" method="POST">
            <button class="btn btn-primary">Proceder al Pago</button>
        </form>
    </div>
</div>

{% else %}
    <p class="flash-message">Tu carrito está vacío</p>
    <form action="/" method="GET">
            <button class="btn btn-primary">Seguir Comprando</button>
    </form>
{% endif %}

</div>
{% endblock %}
